"use strict";(self.webpackChunkpersonal_blog=self.webpackChunkpersonal_blog||[]).push([["9284"],{11629:function(n,e,r){r.r(e),r.d(e,{frontMatter:()=>i,toc:()=>o,default:()=>h,metadata:()=>s,assets:()=>d,contentTitle:()=>l});var s=JSON.parse('{"id":"Trace/bpftrace observe function execution time","title":"bpftrace observe function execution time","description":"\u8981\u8DDF\u8E2A\u81EA\u5DF1\u7F16\u5199\u7684\u51FD\u6570\u7684\u8017\u65F6\uFF0C\u53EF\u4EE5\u5229\u7528 eBPF \u7684 uprobe \u548C uretprobe \u529F\u80FD\uFF0C\u56E0\u4E3A\u8FD9\u4E9B\u63A2\u6D4B\u70B9\u53EF\u4EE5\u8DDF\u8E2A\u7528\u6237\u7A7A\u95F4\u7684\u51FD\u6570\u6267\u884C\u65F6\u95F4\u3002\u4EE5\u4E0B\u662F\u5B9E\u73B0\u8FC7\u7A0B\u7684\u8BE6\u7EC6\u6B65\u9AA4\uFF1A","source":"@site/knowledges/Trace/bpftrace observe function execution time.md","sourceDirName":"Trace","slug":"/Trace/bpftrace observe function execution time","permalink":"/zh-CN/knowledges/Trace/bpftrace observe function execution time","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"readings","previous":{"title":"ffmpeg","permalink":"/zh-CN/knowledges/Software-Usage/ffmpeg"},"next":{"title":"\u5728\u5BB9\u5668\u4E2D\u4F7F\u7528 BCC","permalink":"/zh-CN/knowledges/Trace/use bcc in container"}}'),c=r(74848),t=r(84429);let i={},l,d={},o=[{value:"\u73AF\u5883\u51C6\u5907",id:"\u73AF\u5883\u51C6\u5907",level:2},{value:"\u4F7F\u7528 <code>bpftrace</code> \u8DDF\u8E2A\u51FD\u6570\u8017\u65F6",id:"\u4F7F\u7528-bpftrace-\u8DDF\u8E2A\u51FD\u6570\u8017\u65F6",level:2},{value:"\u4F7F\u7528 <code>bcc</code> \u5B9E\u73B0\u81EA\u5B9A\u4E49\u903B\u8F91",id:"\u4F7F\u7528-bcc-\u5B9E\u73B0\u81EA\u5B9A\u4E49\u903B\u8F91",level:2},{value:"\u793A\u4F8B\u4EE3\u7801",id:"\u793A\u4F8B\u4EE3\u7801",level:3},{value:"\u8FD0\u884C\u65B9\u6CD5",id:"\u8FD0\u884C\u65B9\u6CD5",level:3},{value:"\u6CE8\u610F\u4E8B\u9879",id:"\u6CE8\u610F\u4E8B\u9879",level:2}];function a(n){let e={br:"br",code:"code",h2:"h2",h3:"h3",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...n.components};return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsxs)(e.p,{children:["\u8981\u8DDF\u8E2A\u81EA\u5DF1\u7F16\u5199\u7684\u51FD\u6570\u7684\u8017\u65F6\uFF0C\u53EF\u4EE5\u5229\u7528 ",(0,c.jsx)(e.strong,{children:"eBPF"})," \u7684 ",(0,c.jsx)(e.code,{children:"uprobe"})," \u548C ",(0,c.jsx)(e.code,{children:"uretprobe"})," \u529F\u80FD\uFF0C\u56E0\u4E3A\u8FD9\u4E9B\u63A2\u6D4B\u70B9\u53EF\u4EE5\u8DDF\u8E2A\u7528\u6237\u7A7A\u95F4\u7684\u51FD\u6570\u6267\u884C\u65F6\u95F4\u3002\u4EE5\u4E0B\u662F\u5B9E\u73B0\u8FC7\u7A0B\u7684\u8BE6\u7EC6\u6B65\u9AA4\uFF1A"]}),"\n",(0,c.jsx)(e.hr,{}),"\n",(0,c.jsx)(e.p,{children:"[[use bcc in container]]"}),"\n",(0,c.jsx)(e.h2,{id:"\u73AF\u5883\u51C6\u5907",children:"\u73AF\u5883\u51C6\u5907"}),"\n",(0,c.jsxs)(e.ol,{children:["\n",(0,c.jsxs)(e.li,{children:["\n",(0,c.jsxs)(e.p,{children:[(0,c.jsx)(e.strong,{children:"\u786E\u4FDD\u652F\u6301 eBPF"}),"\uFF1A"]}),"\n",(0,c.jsxs)(e.ul,{children:["\n",(0,c.jsx)(e.li,{children:"\u786E\u4FDD Linux \u5185\u6838\u7248\u672C >= 4.4\uFF0C\u63A8\u8350\u4F7F\u7528 5.x \u6216\u66F4\u65B0\u7248\u672C\u3002"}),"\n",(0,c.jsxs)(e.li,{children:["\u786E\u4FDD\u5B89\u88C5\u4E86 eBPF \u5DE5\u5177\uFF0C\u5982 ",(0,c.jsx)(e.code,{children:"bpftrace"})," \u6216 ",(0,c.jsx)(e.code,{children:"bcc"}),"\u3002"]}),"\n"]}),"\n"]}),"\n",(0,c.jsxs)(e.li,{children:["\n",(0,c.jsxs)(e.p,{children:[(0,c.jsx)(e.strong,{children:"\u7F16\u8BD1\u4F60\u7684\u7A0B\u5E8F"}),"\uFF1A"]}),"\n",(0,c.jsxs)(e.ul,{children:["\n",(0,c.jsxs)(e.li,{children:["\n",(0,c.jsxs)(e.p,{children:["\u786E\u4FDD\u4F60\u7684\u7A0B\u5E8F\u5E26\u6709\u8C03\u8BD5\u7B26\u53F7\uFF08",(0,c.jsx)(e.code,{children:"-g"}),"\uFF09\uFF0C\u4EE5\u4FBF\u80FD\u627E\u5230\u51FD\u6570\u7B26\u53F7\u3002"]}),"\n"]}),"\n",(0,c.jsxs)(e.li,{children:["\n",(0,c.jsxs)(e.p,{children:["\u793A\u4F8B\u7A0B\u5E8F ",(0,c.jsx)(e.code,{children:"my_program"}),"\uFF1A"]}),"\n",(0,c.jsx)(e.pre,{children:(0,c.jsx)(e.code,{className:"language-c",children:'#include <stdio.h>\n#include <unistd.h>\n\nvoid my_function() {\n    sleep(1);  // \u6A21\u62DF\u8017\u65F6\u64CD\u4F5C\n    printf("Inside my_function\\n");\n}\n\nint main() {\n    my_function();\n    return 0;\n}\n'})}),"\n"]}),"\n",(0,c.jsxs)(e.li,{children:["\n",(0,c.jsx)(e.p,{children:"\u7F16\u8BD1\uFF1A"}),"\n",(0,c.jsx)(e.pre,{children:(0,c.jsx)(e.code,{className:"language-bash",children:"gcc -g -o my_program my_program.c\n"})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,c.jsx)(e.hr,{}),"\n",(0,c.jsxs)(e.h2,{id:"\u4F7F\u7528-bpftrace-\u8DDF\u8E2A\u51FD\u6570\u8017\u65F6",children:["\u4F7F\u7528 ",(0,c.jsx)(e.code,{children:"bpftrace"})," \u8DDF\u8E2A\u51FD\u6570\u8017\u65F6"]}),"\n",(0,c.jsxs)(e.ol,{children:["\n",(0,c.jsxs)(e.li,{children:["\n",(0,c.jsxs)(e.p,{children:[(0,c.jsx)(e.strong,{children:"\u67E5\u627E\u51FD\u6570\u7B26\u53F7"}),"\uFF1A",(0,c.jsx)(e.br,{}),"\n","\u4F7F\u7528 ",(0,c.jsx)(e.code,{children:"nm"})," \u6216 ",(0,c.jsx)(e.code,{children:"objdump"})," \u786E\u5B9A\u8981\u8DDF\u8E2A\u7684\u51FD\u6570\u7B26\u53F7\uFF1A"]}),"\n",(0,c.jsx)(e.pre,{children:(0,c.jsx)(e.code,{className:"language-bash",children:"nm my_program | grep my_function\n"})}),"\n",(0,c.jsx)(e.p,{children:"\u8F93\u51FA\u793A\u4F8B\uFF1A"}),"\n",(0,c.jsx)(e.pre,{children:(0,c.jsx)(e.code,{children:"0000000000001169 T my_function\n"})}),"\n",(0,c.jsxs)(e.p,{children:[(0,c.jsx)(e.code,{children:"my_function"})," \u662F\u5168\u5C40\u7B26\u53F7\uFF0C\u53EF\u4EE5\u76F4\u63A5\u8DDF\u8E2A\u3002"]}),"\n"]}),"\n",(0,c.jsxs)(e.li,{children:["\n",(0,c.jsxs)(e.p,{children:[(0,c.jsx)(e.strong,{children:"\u7F16\u5199 bpftrace \u811A\u672C"}),"\uFF1A",(0,c.jsx)(e.br,{}),"\n","\u5047\u8BBE\u4F60\u7684\u7A0B\u5E8F\u8DEF\u5F84\u662F ",(0,c.jsx)(e.code,{children:"/path/to/my_program"}),"\uFF0C\u53EF\u4EE5\u7F16\u5199\u5982\u4E0B ",(0,c.jsx)(e.code,{children:"bpftrace"})," \u811A\u672C\uFF1A"]}),"\n"]}),"\n"]}),"\n",(0,c.jsx)(e.pre,{children:(0,c.jsx)(e.code,{className:"language-bash",children:'\ncat <<EOF > my_bpftrace_script.bt\nuprobe:/path/to/my_program:my_function {\n    @start[tid] = nsecs;\n}\nuretprobe:/path/to/my_program:my_function {\n    if (@start[tid]) {\n        printf("Function my_function latency: %d ns\\n", nsecs - @start[tid]);\n        delete(@start[tid]);\n    }\n}\nEOF\n\nbpftrace my_bpftrace_script.bt\n\n'})}),"\n",(0,c.jsxs)(e.ol,{start:"3",children:["\n",(0,c.jsxs)(e.li,{children:["\n",(0,c.jsxs)(e.p,{children:[(0,c.jsx)(e.strong,{children:"\u8FD0\u884C\u7A0B\u5E8F"}),"\uFF1A",(0,c.jsx)(e.br,{}),"\n","\u5728\u53E6\u4E00\u4E2A\u7EC8\u7AEF\u8FD0\u884C\u4F60\u7684\u7A0B\u5E8F\uFF1A"]}),"\n",(0,c.jsx)(e.pre,{children:(0,c.jsx)(e.code,{className:"language-bash",children:"./my_program\n"})}),"\n"]}),"\n",(0,c.jsxs)(e.li,{children:["\n",(0,c.jsxs)(e.p,{children:[(0,c.jsx)(e.strong,{children:"\u67E5\u770B\u8F93\u51FA"}),"\uFF1A",(0,c.jsx)(e.br,{}),"\n","\u5728\u8FD0\u884C ",(0,c.jsx)(e.code,{children:"bpftrace"})," \u7684\u7EC8\u7AEF\u53EF\u4EE5\u770B\u5230\u7C7B\u4F3C\u8F93\u51FA\uFF1A"]}),"\n",(0,c.jsx)(e.pre,{children:(0,c.jsx)(e.code,{children:"Function my_function latency: 1000078023 ns\n"})}),"\n"]}),"\n"]}),"\n",(0,c.jsx)(e.hr,{}),"\n",(0,c.jsxs)(e.h2,{id:"\u4F7F\u7528-bcc-\u5B9E\u73B0\u81EA\u5B9A\u4E49\u903B\u8F91",children:["\u4F7F\u7528 ",(0,c.jsx)(e.code,{children:"bcc"})," \u5B9E\u73B0\u81EA\u5B9A\u4E49\u903B\u8F91"]}),"\n",(0,c.jsxs)(e.p,{children:["\u5982\u679C\u9700\u8981\u66F4\u590D\u6742\u7684\u529F\u80FD\uFF08\u5982\u4FDD\u5B58\u8017\u65F6\u7EDF\u8BA1\u3001\u8DE8\u591A\u6B21\u8FD0\u884C\u5206\u6790\uFF09\uFF0C\u53EF\u4EE5\u4F7F\u7528 ",(0,c.jsx)(e.code,{children:"bcc"})," \u7F16\u5199\u4E00\u4E2A Python \u811A\u672C\u3002"]}),"\n",(0,c.jsx)(e.h3,{id:"\u793A\u4F8B\u4EE3\u7801",children:"\u793A\u4F8B\u4EE3\u7801"}),"\n",(0,c.jsx)(e.pre,{children:(0,c.jsx)(e.code,{className:"language-python",children:'from bcc import BPF\n\n# eBPF \u7A0B\u5E8F\nbpf_program = """\n#include <uapi/linux/ptrace.h>\n\nBPF_HASH(start, u32, u64);\n\nint trace_entry(struct pt_regs *ctx) {\n    u32 tid = bpf_get_current_pid_tgid();\n    u64 ts = bpf_ktime_get_ns();\n    start.update(&tid, &ts);\n    return 0;\n}\n\nint trace_return(struct pt_regs *ctx) {\n    u32 tid = bpf_get_current_pid_tgid();\n    u64 *tsp = start.lookup(&tid);\n    if (tsp != 0) {\n        u64 delta = bpf_ktime_get_ns() - *tsp;\n        bpf_trace_printk("Function latency: %llu ns\\\\n", delta);\n        start.delete(&tid);\n    }\n    return 0;\n}\n"""\n\n# \u52A0\u8F7D eBPF \u7A0B\u5E8F\nb = BPF(text=bpf_program)\n\n# \u7ED1\u5B9A\u51FD\u6570\u63A2\u6D4B\u70B9\nbinary_path = "/path/to/my_program"\nb.attach_uprobe(name=binary_path, sym="my_function", fn_name="trace_entry")\nb.attach_uretprobe(name=binary_path, sym="my_function", fn_name="trace_return")\n\n# \u8F93\u51FA\u7ED3\u679C\nprint("Tracing... Press Ctrl+C to stop.")\ntry:\n    b.trace_print()\nexcept KeyboardInterrupt:\n    pass\n'})}),"\n",(0,c.jsx)(e.h3,{id:"\u8FD0\u884C\u65B9\u6CD5",children:"\u8FD0\u884C\u65B9\u6CD5"}),"\n",(0,c.jsxs)(e.ol,{children:["\n",(0,c.jsxs)(e.li,{children:["\n",(0,c.jsxs)(e.p,{children:["\u4FDD\u5B58\u4E3A ",(0,c.jsx)(e.code,{children:"trace_my_function.py"}),"\u3002"]}),"\n"]}),"\n",(0,c.jsxs)(e.li,{children:["\n",(0,c.jsx)(e.p,{children:"\u8FD0\u884C\uFF1A"}),"\n",(0,c.jsx)(e.pre,{children:(0,c.jsx)(e.code,{className:"language-bash",children:"sudo python3 trace_my_function.py\n"})}),"\n"]}),"\n",(0,c.jsxs)(e.li,{children:["\n",(0,c.jsx)(e.p,{children:"\u5728\u53E6\u4E00\u7EC8\u7AEF\u8FD0\u884C\u7A0B\u5E8F\uFF1A"}),"\n",(0,c.jsx)(e.pre,{children:(0,c.jsx)(e.code,{className:"language-bash",children:"./my_program\n"})}),"\n"]}),"\n",(0,c.jsxs)(e.li,{children:["\n",(0,c.jsx)(e.p,{children:"\u67E5\u770B\u8F93\u51FA\uFF1A"}),"\n",(0,c.jsx)(e.pre,{children:(0,c.jsx)(e.code,{children:"Function latency: 1000000123 ns\n"})}),"\n"]}),"\n"]}),"\n",(0,c.jsx)(e.hr,{}),"\n",(0,c.jsx)(e.h2,{id:"\u6CE8\u610F\u4E8B\u9879",children:"\u6CE8\u610F\u4E8B\u9879"}),"\n",(0,c.jsxs)(e.ol,{children:["\n",(0,c.jsxs)(e.li,{children:["\n",(0,c.jsxs)(e.p,{children:[(0,c.jsx)(e.strong,{children:"\u52A8\u6001\u5E93\u7684\u51FD\u6570"}),"\uFF1A",(0,c.jsx)(e.br,{}),"\n","\u5982\u679C\u4F60\u7684\u51FD\u6570\u4F4D\u4E8E\u52A8\u6001\u5E93\u4E2D\uFF0C\u9700\u8981\u4F7F\u7528 ",(0,c.jsx)(e.code,{children:"ldd"})," \u627E\u5230\u52A8\u6001\u5E93\u8DEF\u5F84\uFF0C\u5E76\u7528 ",(0,c.jsx)(e.code,{children:"uprobe"})," \u6307\u5B9A\u5E93\u8DEF\u5F84\u3002"]}),"\n"]}),"\n",(0,c.jsxs)(e.li,{children:["\n",(0,c.jsxs)(e.p,{children:[(0,c.jsx)(e.strong,{children:"\u591A\u7EBF\u7A0B\u7A0B\u5E8F"}),"\uFF1A",(0,c.jsx)(e.br,{}),"\n","\u5BF9\u591A\u7EBF\u7A0B\u7A0B\u5E8F\uFF0C\u53EF\u4EE5\u7528\u7EBF\u7A0B ID (",(0,c.jsx)(e.code,{children:"tid"}),") \u6765\u533A\u5206\u51FD\u6570\u8C03\u7528\u3002"]}),"\n"]}),"\n",(0,c.jsxs)(e.li,{children:["\n",(0,c.jsxs)(e.p,{children:[(0,c.jsx)(e.strong,{children:"\u6027\u80FD\u5F00\u9500"}),"\uFF1A",(0,c.jsx)(e.br,{}),"\n","eBPF \u7684\u5F00\u9500\u6781\u4F4E\uFF0C\u4F46\u4ECD\u5EFA\u8BAE\u907F\u514D\u5728\u9AD8\u9891\u51FD\u6570\u4E0A\u957F\u671F\u8FD0\u884C\u63A2\u6D4B\u3002"]}),"\n"]}),"\n",(0,c.jsxs)(e.li,{children:["\n",(0,c.jsxs)(e.p,{children:[(0,c.jsx)(e.strong,{children:"\u5B89\u5168\u6027"}),"\uFF1A",(0,c.jsx)(e.br,{}),"\n","\u8FD0\u884C\u9700\u8981 ",(0,c.jsx)(e.code,{children:"sudo"})," \u6743\u9650\uFF0C\u4F46\u5BF9\u76EE\u6807\u7A0B\u5E8F\u65E0\u4FB5\u5165\u6027\uFF0C\u4E0D\u4F1A\u4FEE\u6539\u7A0B\u5E8F\u884C\u4E3A\u3002"]}),"\n"]}),"\n"]}),"\n",(0,c.jsx)(e.hr,{}),"\n",(0,c.jsx)(e.p,{children:"\u8FD9\u79CD\u65B9\u5F0F\u80FD\u9AD8\u6548\u8DDF\u8E2A\u81EA\u5B9A\u4E49\u51FD\u6570\u7684\u8017\u65F6\uFF0C\u5E76\u63D0\u4F9B\u6781\u5927\u7684\u7075\u6D3B\u6027\uFF0C\u9002\u7528\u4E8E\u8C03\u8BD5\u548C\u6027\u80FD\u5206\u6790\u573A\u666F\u3002"})]})}function h(n={}){let{wrapper:e}={...(0,t.R)(),...n.components};return e?(0,c.jsx)(e,{...n,children:(0,c.jsx)(a,{...n})}):a(n)}},84429:function(n,e,r){r.d(e,{R:()=>i,x:()=>l});var s=r(96540);let c={},t=s.createContext(c);function i(n){let e=s.useContext(t);return s.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function l(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(c):n.components||c:i(n.components),s.createElement(t.Provider,{value:e},n.children)}}}]);