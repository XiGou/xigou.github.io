"use strict";(self.webpackChunkpersonal_blog=self.webpackChunkpersonal_blog||[]).push([[7722],{28453:(n,e,d)=>{d.d(e,{R:()=>o,x:()=>r});var i=d(96540);const l={},s=i.createContext(l);function o(n){const e=i.useContext(s);return i.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function r(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(l):n.components||l:o(n.components),i.createElement(s.Provider,{value:e},n.children)}},75547:(n,e,d)=>{d.r(e),d.d(e,{assets:()=>c,contentTitle:()=>r,default:()=>f,frontMatter:()=>o,metadata:()=>i,toc:()=>t});const i=JSON.parse('{"id":"CPP/fd allocation in Linux","title":"Linux \u4e2d\u7684 fd \u5206\u914d","description":"\u5728 Linux/Unix \u7cfb\u7edf\u4e2d\uff0c\u6587\u4ef6\u63cf\u8ff0\u7b26\uff08fd\uff09\u662f\u64cd\u4f5c\u7cfb\u7edf\u4e3a\u6bcf\u4e2a\u6253\u5f00\u7684\u6587\u4ef6\u3001\u5957\u63a5\u5b57\u6216\u7ba1\u9053\u5206\u914d\u7684 \u6574\u6570\u7f16\u53f7\u3002","source":"@site/knowledges/CPP/fd allocation in Linux.md","sourceDirName":"CPP","slug":"/CPP/fd allocation in Linux","permalink":"/zh-CN/knowledges/CPP/fd allocation in Linux","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"title":"Linux \u4e2d\u7684 fd \u5206\u914d"},"sidebar":"readings","previous":{"title":"gcc/g++\u7f16\u8bd1\u53c2\u6570\u987a\u5e8f\u6240\u5f15\u8d77\u7684\u94fe\u63a5\u9519\u8bef","permalink":"/zh-CN/knowledges/CPP/Repost-gcc_g++_args_should_put_in_order"},"next":{"title":"Commit Type in Git or Github workflow","permalink":"/zh-CN/knowledges/Collaboration/Commit Type in Git or Github workflow"}}');var l=d(74848),s=d(28453);const o={title:"Linux \u4e2d\u7684 fd \u5206\u914d"},r=void 0,c={},t=[{value:"\u5173\u952e\u6982\u5ff5",id:"\u5173\u952e\u6982\u5ff5",level:2},{value:"\u5b9e\u9a8c\uff1a\u4e3b\u7a0b\u5e8f\u548c\u52a8\u6001\u5e93\u5206\u914d fd",id:"\u5b9e\u9a8c\u4e3b\u7a0b\u5e8f\u548c\u52a8\u6001\u5e93\u5206\u914d-fd",level:2},{value:"\u52a8\u6001\u5e93 B (libb.so)",id:"\u52a8\u6001\u5e93-b-libbso",level:3},{value:"\u4e3b\u7a0b\u5e8f A",id:"\u4e3b\u7a0b\u5e8f-a",level:3},{value:"\u8fd0\u884c\u7ed3\u679c",id:"\u8fd0\u884c\u7ed3\u679c",level:3}];function h(n){const e={code:"code",h2:"h2",h3:"h3",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...n.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsxs)(e.p,{children:["\u5728 Linux/Unix \u7cfb\u7edf\u4e2d\uff0c\u6587\u4ef6\u63cf\u8ff0\u7b26\uff08fd\uff09\u662f\u64cd\u4f5c\u7cfb\u7edf\u4e3a\u6bcf\u4e2a\u6253\u5f00\u7684\u6587\u4ef6\u3001\u5957\u63a5\u5b57\u6216\u7ba1\u9053\u5206\u914d\u7684 ",(0,l.jsx)(e.strong,{children:"\u6574\u6570\u7f16\u53f7"}),"\u3002"]}),"\n",(0,l.jsx)(e.h2,{id:"\u5173\u952e\u6982\u5ff5",children:"\u5173\u952e\u6982\u5ff5"}),"\n",(0,l.jsxs)(e.ol,{children:["\n",(0,l.jsxs)(e.li,{children:["\n",(0,l.jsx)(e.p,{children:(0,l.jsx)(e.strong,{children:"fd \u662f\u8fdb\u7a0b\u5185\u5168\u5c40\u7684"})}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["\u6bcf\u4e2a\u8fdb\u7a0b\u6709\u81ea\u5df1\u7684 fd \u8868\uff0cfd \u662f ",(0,l.jsx)(e.strong,{children:"\u8fdb\u7a0b\u5c40\u90e8\u7f16\u53f7"}),"\u3002"]}),"\n",(0,l.jsx)(e.li,{children:"\u4e0d\u540c\u8fdb\u7a0b\u53ef\u4ee5\u6709\u76f8\u540c\u7684 fd \u7f16\u53f7\uff0c\u4f46\u5728\u540c\u4e00\u8fdb\u7a0b\u5185\u662f\u552f\u4e00\u7684\u3002"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\n",(0,l.jsx)(e.p,{children:(0,l.jsx)(e.strong,{children:"fd \u4ece 0 \u5f00\u59cb\u5206\u914d"})}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.code,{children:"0"})," \u2192 stdin"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.code,{children:"1"})," \u2192 stdout"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.code,{children:"2"})," \u2192 stderr"]}),"\n",(0,l.jsxs)(e.li,{children:["\u65b0\u7684 fd \u5206\u914d\u4e3a ",(0,l.jsx)(e.strong,{children:"\u5f53\u524d\u53ef\u7528\u7684\u6700\u5c0f\u6574\u6570"}),"\uff0c\u5173\u95ed\u7684 fd \u53ef\u4ee5\u88ab\u590d\u7528\u3002"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\n",(0,l.jsx)(e.p,{children:(0,l.jsx)(e.strong,{children:"\u52a8\u6001\u5e93\u4e0d\u4f1a\u72ec\u7acb\u5206\u914d fd"})}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["\u53ea\u8981\u5728\u540c\u4e00\u8fdb\u7a0b\u5185\u8c03\u7528 ",(0,l.jsx)(e.code,{children:"open()"})," \u6216 ",(0,l.jsx)(e.code,{children:"socket()"}),"\uff0cfd \u90fd\u4ece\u540c\u4e00\u5f20 fd \u8868\u4e2d\u5206\u914d\u3002"]}),"\n",(0,l.jsx)(e.li,{children:"\u4e0e\u662f\u4e3b\u7a0b\u5e8f\u8fd8\u662f\u52a8\u6001\u5e93\u65e0\u5173\u3002"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\n",(0,l.jsxs)(e.p,{children:[(0,l.jsx)(e.strong,{children:"fd \u5728\u8fdb\u7a0b\u5185\u662f\u5168\u5c40\u7684"}),"\uff1a\u4e0d\u7ba1\u662f\u4e3b\u7a0b\u5e8f\u8fd8\u662f\u52a8\u6001\u5e93\uff0c\u90fd\u662f\u540c\u4e00\u5f20\u8868\u3002"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\n",(0,l.jsxs)(e.p,{children:[(0,l.jsx)(e.strong,{children:"\u5173\u95ed\u7684 fd \u53ef\u4ee5\u590d\u7528"}),"\uff1a\u5206\u914d\u603b\u662f\u9009\u62e9\u6700\u5c0f\u53ef\u7528\u6574\u6570\u3002"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\n",(0,l.jsxs)(e.p,{children:[(0,l.jsx)(e.strong,{children:"\u8de8\u8fdb\u7a0b fd \u4e0d\u5171\u4eab"}),"\uff1a\u4e0d\u540c\u8fdb\u7a0b\u7684 fd \u7f16\u53f7\u53ef\u4ee5\u76f8\u540c\uff0c\u4f46\u5b83\u4eec\u4e92\u4e0d\u5e72\u6270\u3002"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.hr,{}),"\n",(0,l.jsx)(e.h2,{id:"\u5b9e\u9a8c\u4e3b\u7a0b\u5e8f\u548c\u52a8\u6001\u5e93\u5206\u914d-fd",children:"\u5b9e\u9a8c\uff1a\u4e3b\u7a0b\u5e8f\u548c\u52a8\u6001\u5e93\u5206\u914d fd"}),"\n",(0,l.jsx)(e.h3,{id:"\u52a8\u6001\u5e93-b-libbso",children:"\u52a8\u6001\u5e93 B (libb.so)"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-cpp",children:'// libb.cpp\n#include <fcntl.h>\n#include <unistd.h>\n#include <vector>\n#include <iostream>\n\nstd::vector<int> b_fds;\n\nextern "C" void b_open(int n) {\n    for (int i = 0; i < n; ++i) {\n        int fd = open("/dev/null", O_RDONLY);\n        b_fds.push_back(fd);\n        std::cout << "[B] opened fd: " << fd << std::endl;\n    }\n}\n\nextern "C" void b_close_all() {\n    for (int fd : b_fds) close(fd);\n    b_fds.clear();\n}\n'})}),"\n",(0,l.jsx)(e.hr,{}),"\n",(0,l.jsx)(e.h3,{id:"\u4e3b\u7a0b\u5e8f-a",children:"\u4e3b\u7a0b\u5e8f A"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-cpp",children:'// main.cpp\n#include <fcntl.h>\n#include <unistd.h>\n#include <iostream>\n#include <vector>\n#include <dlfcn.h>\n\nint main() {\n    // A Open 3 fd\n    for (int i = 0; i < 3; ++i) open("/dev/null", O_RDONLY);\n\n    // load B\n    void* handle = dlopen("./libb.so", RTLD_LAZY);\n    auto b_open = (void(*)(int)) dlsym(handle, "b_open");\n    b_open(10); // B \u6253\u5f00 10 \u4e2a fd\n\n    // A open one more fd\n    int fd = open("/dev/null", O_RDONLY);\n    std::cout << "[A] opened fd after B: " << fd << std::endl;\n\n    dlclose(handle);\n    return 0;\n}\n'})}),"\n",(0,l.jsx)(e.hr,{}),"\n",(0,l.jsx)(e.h3,{id:"\u8fd0\u884c\u7ed3\u679c",children:"\u8fd0\u884c\u7ed3\u679c"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-bash",children:"\u279c g++ -fPIC -shared -o libb.so libb.cpp\n\n\u279c g++ main.cpp -ldl -o main            \n\n\u279c ./main\n[A] opened fd: 3\n[A] opened fd: 4\n[A] opened fd: 5\n[B] opened fd: 6\n[B] opened fd: 7\n[B] opened fd: 8\n[B] opened fd: 9\n[B] opened fd: 10\n[B] opened fd: 11\n[B] opened fd: 12\n[B] opened fd: 13\n[B] opened fd: 14\n[B] opened fd: 15\n[A] opened fd after B: 16\n"})})]})}function f(n={}){const{wrapper:e}={...(0,s.R)(),...n.components};return e?(0,l.jsx)(e,{...n,children:(0,l.jsx)(h,{...n})}):h(n)}}}]);