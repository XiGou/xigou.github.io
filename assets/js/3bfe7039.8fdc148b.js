"use strict";(self.webpackChunkpersonal_blog=self.webpackChunkpersonal_blog||[]).push([["4695"],{8796:function(n,e,d){d.r(e),d.d(e,{frontMatter:()=>o,toc:()=>c,default:()=>h,metadata:()=>l,assets:()=>t,contentTitle:()=>r});var l=JSON.parse('{"id":"CPP/fd allocation in Linux","title":"Linux \u4E2D\u7684 fd \u5206\u914D","description":"\u5728 Linux/Unix \u7CFB\u7EDF\u4E2D\uFF0C\u6587\u4EF6\u63CF\u8FF0\u7B26\uFF08fd\uFF09\u662F\u64CD\u4F5C\u7CFB\u7EDF\u4E3A\u6BCF\u4E2A\u6253\u5F00\u7684\u6587\u4EF6\u3001\u5957\u63A5\u5B57\u6216\u7BA1\u9053\u5206\u914D\u7684 \u6574\u6570\u7F16\u53F7\u3002","source":"@site/knowledges/CPP/fd allocation in Linux.md","sourceDirName":"CPP","slug":"/CPP/fd allocation in Linux","permalink":"/knowledges/CPP/fd allocation in Linux","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"title":"Linux \u4E2D\u7684 fd \u5206\u914D"},"sidebar":"readings","previous":{"title":"gcc/g++\u7F16\u8BD1\u53C2\u6570\u987A\u5E8F\u6240\u5F15\u8D77\u7684\u94FE\u63A5\u9519\u8BEF","permalink":"/knowledges/CPP/Repost-gcc_g++_args_should_put_in_order"},"next":{"title":"Commit Type in Git or Github workflow","permalink":"/knowledges/Collaboration/Commit Type in Git or Github workflow"}}'),i=d(74848),s=d(84429);let o={title:"Linux \u4E2D\u7684 fd \u5206\u914D"},r,t={},c=[{value:"\u5173\u952E\u6982\u5FF5",id:"\u5173\u952E\u6982\u5FF5",level:2},{value:"\u5B9E\u9A8C\uFF1A\u4E3B\u7A0B\u5E8F\u548C\u52A8\u6001\u5E93\u5206\u914D fd",id:"\u5B9E\u9A8C\u4E3B\u7A0B\u5E8F\u548C\u52A8\u6001\u5E93\u5206\u914D-fd",level:2},{value:"\u52A8\u6001\u5E93 B (libb.so)",id:"\u52A8\u6001\u5E93-b-libbso",level:3},{value:"\u4E3B\u7A0B\u5E8F A",id:"\u4E3B\u7A0B\u5E8F-a",level:3},{value:"\u8FD0\u884C\u7ED3\u679C",id:"\u8FD0\u884C\u7ED3\u679C",level:3}];function f(n){let e={code:"code",h2:"h2",h3:"h3",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...n.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(e.p,{children:["\u5728 Linux/Unix \u7CFB\u7EDF\u4E2D\uFF0C\u6587\u4EF6\u63CF\u8FF0\u7B26\uFF08fd\uFF09\u662F\u64CD\u4F5C\u7CFB\u7EDF\u4E3A\u6BCF\u4E2A\u6253\u5F00\u7684\u6587\u4EF6\u3001\u5957\u63A5\u5B57\u6216\u7BA1\u9053\u5206\u914D\u7684 ",(0,i.jsx)(e.strong,{children:"\u6574\u6570\u7F16\u53F7"}),"\u3002"]}),"\n",(0,i.jsx)(e.h2,{id:"\u5173\u952E\u6982\u5FF5",children:"\u5173\u952E\u6982\u5FF5"}),"\n",(0,i.jsxs)(e.ol,{children:["\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"fd \u662F\u8FDB\u7A0B\u5185\u5168\u5C40\u7684"})}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["\u6BCF\u4E2A\u8FDB\u7A0B\u6709\u81EA\u5DF1\u7684 fd \u8868\uFF0Cfd \u662F ",(0,i.jsx)(e.strong,{children:"\u8FDB\u7A0B\u5C40\u90E8\u7F16\u53F7"}),"\u3002"]}),"\n",(0,i.jsx)(e.li,{children:"\u4E0D\u540C\u8FDB\u7A0B\u53EF\u4EE5\u6709\u76F8\u540C\u7684 fd \u7F16\u53F7\uFF0C\u4F46\u5728\u540C\u4E00\u8FDB\u7A0B\u5185\u662F\u552F\u4E00\u7684\u3002"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"fd \u4ECE 0 \u5F00\u59CB\u5206\u914D"})}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"0"})," \u2192 stdin"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"1"})," \u2192 stdout"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"2"})," \u2192 stderr"]}),"\n",(0,i.jsxs)(e.li,{children:["\u65B0\u7684 fd \u5206\u914D\u4E3A ",(0,i.jsx)(e.strong,{children:"\u5F53\u524D\u53EF\u7528\u7684\u6700\u5C0F\u6574\u6570"}),"\uFF0C\u5173\u95ED\u7684 fd \u53EF\u4EE5\u88AB\u590D\u7528\u3002"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"\u52A8\u6001\u5E93\u4E0D\u4F1A\u72EC\u7ACB\u5206\u914D fd"})}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["\u53EA\u8981\u5728\u540C\u4E00\u8FDB\u7A0B\u5185\u8C03\u7528 ",(0,i.jsx)(e.code,{children:"open()"})," \u6216 ",(0,i.jsx)(e.code,{children:"socket()"}),"\uFF0Cfd \u90FD\u4ECE\u540C\u4E00\u5F20 fd \u8868\u4E2D\u5206\u914D\u3002"]}),"\n",(0,i.jsx)(e.li,{children:"\u4E0E\u662F\u4E3B\u7A0B\u5E8F\u8FD8\u662F\u52A8\u6001\u5E93\u65E0\u5173\u3002"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"fd \u5728\u8FDB\u7A0B\u5185\u662F\u5168\u5C40\u7684"}),"\uFF1A\u4E0D\u7BA1\u662F\u4E3B\u7A0B\u5E8F\u8FD8\u662F\u52A8\u6001\u5E93\uFF0C\u90FD\u662F\u540C\u4E00\u5F20\u8868\u3002"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"\u5173\u95ED\u7684 fd \u53EF\u4EE5\u590D\u7528"}),"\uFF1A\u5206\u914D\u603B\u662F\u9009\u62E9\u6700\u5C0F\u53EF\u7528\u6574\u6570\u3002"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"\u8DE8\u8FDB\u7A0B fd \u4E0D\u5171\u4EAB"}),"\uFF1A\u4E0D\u540C\u8FDB\u7A0B\u7684 fd \u7F16\u53F7\u53EF\u4EE5\u76F8\u540C\uFF0C\u4F46\u5B83\u4EEC\u4E92\u4E0D\u5E72\u6270\u3002"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.h2,{id:"\u5B9E\u9A8C\u4E3B\u7A0B\u5E8F\u548C\u52A8\u6001\u5E93\u5206\u914D-fd",children:"\u5B9E\u9A8C\uFF1A\u4E3B\u7A0B\u5E8F\u548C\u52A8\u6001\u5E93\u5206\u914D fd"}),"\n",(0,i.jsx)(e.h3,{id:"\u52A8\u6001\u5E93-b-libbso",children:"\u52A8\u6001\u5E93 B (libb.so)"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-cpp",children:'// libb.cpp\n#include <fcntl.h>\n#include <unistd.h>\n#include <vector>\n#include <iostream>\n\nstd::vector<int> b_fds;\n\nextern "C" void b_open(int n) {\n    for (int i = 0; i < n; ++i) {\n        int fd = open("/dev/null", O_RDONLY);\n        b_fds.push_back(fd);\n        std::cout << "[B] opened fd: " << fd << std::endl;\n    }\n}\n\nextern "C" void b_close_all() {\n    for (int fd : b_fds) close(fd);\n    b_fds.clear();\n}\n'})}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.h3,{id:"\u4E3B\u7A0B\u5E8F-a",children:"\u4E3B\u7A0B\u5E8F A"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-cpp",children:'// main.cpp\n#include <fcntl.h>\n#include <unistd.h>\n#include <iostream>\n#include <vector>\n#include <dlfcn.h>\n\nint main() {\n    // A Open 3 fd\n    for (int i = 0; i < 3; ++i) open("/dev/null", O_RDONLY);\n\n    // load B\n    void* handle = dlopen("./libb.so", RTLD_LAZY);\n    auto b_open = (void(*)(int)) dlsym(handle, "b_open");\n    b_open(10); // B \u6253\u5F00 10 \u4E2A fd\n\n    // A open one more fd\n    int fd = open("/dev/null", O_RDONLY);\n    std::cout << "[A] opened fd after B: " << fd << std::endl;\n\n    dlclose(handle);\n    return 0;\n}\n'})}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.h3,{id:"\u8FD0\u884C\u7ED3\u679C",children:"\u8FD0\u884C\u7ED3\u679C"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-bash",children:"\u279C g++ -fPIC -shared -o libb.so libb.cpp\n\n\u279C g++ main.cpp -ldl -o main            \n\n\u279C ./main\n[A] opened fd: 3\n[A] opened fd: 4\n[A] opened fd: 5\n[B] opened fd: 6\n[B] opened fd: 7\n[B] opened fd: 8\n[B] opened fd: 9\n[B] opened fd: 10\n[B] opened fd: 11\n[B] opened fd: 12\n[B] opened fd: 13\n[B] opened fd: 14\n[B] opened fd: 15\n[A] opened fd after B: 16\n"})})]})}function h(n={}){let{wrapper:e}={...(0,s.R)(),...n.components};return e?(0,i.jsx)(e,{...n,children:(0,i.jsx)(f,{...n})}):f(n)}},84429:function(n,e,d){d.d(e,{R:()=>o,x:()=>r});var l=d(96540);let i={},s=l.createContext(i);function o(n){let e=l.useContext(s);return l.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function r(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:o(n.components),l.createElement(s.Provider,{value:e},n.children)}}}]);