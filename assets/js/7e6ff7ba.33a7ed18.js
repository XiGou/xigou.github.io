"use strict";(self.webpackChunkpersonal_blog=self.webpackChunkpersonal_blog||[]).push([[1765],{3045:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>d,contentTitle:()=>c,default:()=>h,frontMatter:()=>s,metadata:()=>t,toc:()=>a});const t=JSON.parse('{"id":"Software-Usage/blktrace","title":"blktrace","description":"\u4f7f\u7528blktrace\u524d\u63d0\u9700\u8981\u6302\u8f7ddebugfs\u3002","source":"@site/knowledges/Software-Usage/blktrace.md","sourceDirName":"Software-Usage","slug":"/Software-Usage/blktrace","permalink":"/knowledges/Software-Usage/blktrace","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"date":"2024-01-06 01:14:31 +0800","title":"blktrace"},"sidebar":"readings","previous":{"title":"Terminal","permalink":"/knowledges/Software-Usage/Terminal"},"next":{"title":"ffmpeg","permalink":"/knowledges/Software-Usage/ffmpeg"}}');var r=i(74848),l=i(28453);const s={date:"2024-01-06 01:14:31 +0800",title:"blktrace"},c=void 0,d={},a=[{value:"\u524d\u8a00",id:"\u524d\u8a00",level:2},{value:"blktrace\u7684\u539f\u7406",id:"blktrace\u7684\u539f\u7406",level:2},{value:"\u4e00\u4e2aI/O\u8bf7\u6c42\u8fdb\u5165block layer\u4e4b\u540e\uff0c\u53ef\u80fd\u4f1a\u7ecf\u5386\u4e0b\u9762\u7684\u8fc7\u7a0b\uff1a",id:"\u4e00\u4e2aio\u8bf7\u6c42\u8fdb\u5165block-layer\u4e4b\u540e\u53ef\u80fd\u4f1a\u7ecf\u5386\u4e0b\u9762\u7684\u8fc7\u7a0b",level:4},{value:"blkparse\u663e\u793a\u7684\u5404\u6307\u6807\u70b9\u793a\u610f\uff1a",id:"blkparse\u663e\u793a\u7684\u5404\u6307\u6807\u70b9\u793a\u610f",level:3},{value:"blktrace \u80fd\u591f\u8bb0\u5f55\u4e0bIO\u6240\u7ecf\u5386\u7684\u5404\u4e2a\u6b65\u9aa4:",id:"blktrace-\u80fd\u591f\u8bb0\u5f55\u4e0bio\u6240\u7ecf\u5386\u7684\u5404\u4e2a\u6b65\u9aa4",level:4},{value:"blktrace\u7684\u7528\u6cd5",id:"blktrace\u7684\u7528\u6cd5",level:2},{value:"\u5b9e\u65f6\u67e5\u770b\uff1a",id:"\u5b9e\u65f6\u67e5\u770b",level:3},{value:"\u5148\u91c7\u96c6\uff0c\u518d\u67e5\u770b\uff1a",id:"\u5148\u91c7\u96c6\u518d\u67e5\u770b",level:3},{value:"blktrace\u4ea7\u751f\u7684\u6587\u4ef6\u592a\u96f6\u6563\u600e\u4e48\u529e\uff1f",id:"blktrace\u4ea7\u751f\u7684\u6587\u4ef6\u592a\u96f6\u6563\u600e\u4e48\u529e",level:3},{value:"\u751f\u6210\u91c7\u96c6\u6587\u4ef6",id:"\u751f\u6210\u91c7\u96c6\u6587\u4ef6",level:4},{value:"\u5408\u5e76\u6210\u4e00\u4e2a\u4e8c\u8fdb\u5236\u6587\u4ef6",id:"\u5408\u5e76\u6210\u4e00\u4e2a\u4e8c\u8fdb\u5236\u6587\u4ef6",level:4},{value:"\u5176\u5b9e\u6211\u4eec\u8fd8\u662f\u5acc\u5f03blkparse\u7684\u8f93\u51fa\u592a\u591a\uff0c\u4e0d\u65b9\u4fbf\u67e5\u770b\uff0c\u6b64\u65f6\u53ef\u4ee5\u5229\u7528btt\u534f\u52a9\u5206\u6790\u7edf\u8ba1",id:"\u5176\u5b9e\u6211\u4eec\u8fd8\u662f\u5acc\u5f03blkparse\u7684\u8f93\u51fa\u592a\u591a\u4e0d\u65b9\u4fbf\u67e5\u770b\u6b64\u65f6\u53ef\u4ee5\u5229\u7528btt\u534f\u52a9\u5206\u6790\u7edf\u8ba1",level:4},{value:"\u4e0a\u8ff0\u547d\u4ee4\u5176\u5b9e\u8fd8\u4f1a\u4ea7\u751f\u4e00\u4e9b.dat\u6587\u4ef6\uff0c\u53ef\u4ee5\u770b\u5230iops\u4fe1\u606f",id:"\u4e0a\u8ff0\u547d\u4ee4\u5176\u5b9e\u8fd8\u4f1a\u4ea7\u751f\u4e00\u4e9bdat\u6587\u4ef6\u53ef\u4ee5\u770b\u5230iops\u4fe1\u606f",level:4},{value:"\u6587\u4ef6\u89e3\u91ca\uff1a",id:"\u6587\u4ef6\u89e3\u91ca",level:4},{value:"\u4fee\u6539blkparse\u7684\u8f93\u51fa\u683c\u5f0f\uff1a",id:"\u4fee\u6539blkparse\u7684\u8f93\u51fa\u683c\u5f0f",level:3},{value:"\u4e00\u6b21IO\u7684\u751f\u547d\u5468\u671f\uff1adirect read \u9644\u5f55\u89c1\u6d4b\u8bd5\u4ee3\u7801",id:"\u4e00\u6b21io\u7684\u751f\u547d\u5468\u671fdirect-read-\u9644\u5f55\u89c1\u6d4b\u8bd5\u4ee3\u7801",level:3},{value:"\u4e00\u6b21IO\u7684\u751f\u547d\u5468\u671f\uff1adirect write \u9644\u5f55\u89c1\u6d4b\u8bd5\u4ee3\u7801",id:"\u4e00\u6b21io\u7684\u751f\u547d\u5468\u671fdirect-write-\u9644\u5f55\u89c1\u6d4b\u8bd5\u4ee3\u7801",level:3},{value:"blktrace -a \u53c2\u6570\u53ef\u4ee5\u6307\u5b9a\u76d1\u63a7\u7684\u52a8\u4f5c\uff1a",id:"blktrace--a-\u53c2\u6570\u53ef\u4ee5\u6307\u5b9a\u76d1\u63a7\u7684\u52a8\u4f5c",level:3},{value:"\u5176\u4ed6\u5de5\u5177",id:"\u5176\u4ed6\u5de5\u5177",level:2},{value:"Ref",id:"ref",level:2},{value:"blktrace git",id:"blktrace-git",level:3},{value:"\u6d4b\u8bd5\u4ee3\u7801",id:"\u6d4b\u8bd5\u4ee3\u7801",level:3}];function o(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,l.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:"\u4f7f\u7528blktrace\u524d\u63d0\u9700\u8981\u6302\u8f7ddebugfs\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"mount      \u2013t debugfs    debugfs /sys/kernel/debug\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"\u7b80\u4ecb\uff1a"})," ## \u524d\u8a00 1. blktrace\u7684\u4f5c\u8005\u6b63\u662fblock io\u7684maintainer\uff0c\u5f00\u53d1\u6b64\u5de5\u5177\uff0c\u53ef\u4ee5\u66f4\u597d\u7684\u8ffd\u8e2aIO\u7684\u8fc7\u7a0b\u3002 2. blktrace \u7ed3\u5408btt\u53ef\u4ee5\u7edf\u8ba1\u4e00\u4e2aIO\u662f\u5728\u8c03\u5ea6\u961f\u5217\u505c\u7559\u7684\u65f6\u95f4\u957f\uff0c\u8fd8\u662f\u5728\u786c\u4ef6\u4e0a\u6d88\u8017\u7684\u65f6\u95f4\u957f\uff0c\u5229\u7528\u8fd9\u4e2a\u5de5\u5177\u53ef\u4ee5\u534f\u52a9\u5206\u6790\u548c\u4f18\u5316\u95ee\u9898\u3002 ## blktrace\u7684\u539f\u7406 \u4e00\u4e2aI/O\u8bf7\u6c42\u7684\u5904\u7406\u8fc7\u7a0b\uff0c\u53ef\u4ee5\u68b3\u7406\u4e3a\u8fd9\u6837\u4e00\u5f20\u7b80\u5355\u7684\u56fe\uff1a ![](",(0,r.jsx)(n.a,{href:"http://image",children:"http://image"})]}),"\n",(0,r.jsx)(n.h2,{id:"\u524d\u8a00",children:"\u524d\u8a00"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"blktrace\u7684\u4f5c\u8005\u6b63\u662fblock io\u7684maintainer\uff0c\u5f00\u53d1\u6b64\u5de5\u5177\uff0c\u53ef\u4ee5\u66f4\u597d\u7684\u8ffd\u8e2aIO\u7684\u8fc7\u7a0b\u3002"}),"\n",(0,r.jsx)(n.li,{children:"blktrace \u7ed3\u5408btt\u53ef\u4ee5\u7edf\u8ba1\u4e00\u4e2aIO\u662f\u5728\u8c03\u5ea6\u961f\u5217\u505c\u7559\u7684\u65f6\u95f4\u957f\uff0c\u8fd8\u662f\u5728\u786c\u4ef6\u4e0a\u6d88\u8017\u7684\u65f6\u95f4\u957f\uff0c\u5229\u7528\u8fd9\u4e2a\u5de5\u5177\u53ef\u4ee5\u534f\u52a9\u5206\u6790\u548c\u4f18\u5316\u95ee\u9898\u3002"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"blktrace\u7684\u539f\u7406",children:"blktrace\u7684\u539f\u7406"}),"\n",(0,r.jsx)(n.p,{children:"\u4e00\u4e2aI/O\u8bf7\u6c42\u7684\u5904\u7406\u8fc7\u7a0b\uff0c\u53ef\u4ee5\u68b3\u7406\u4e3a\u8fd9\u6837\u4e00\u5f20\u7b80\u5355\u7684\u56fe\uff1a"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"http://images2017.cnblogs.com/blog/970272/201711/970272-20171123172717508-1143457314.png?x-oss-process=image/resize,w_1400/format,webp",alt:""})}),"\n",(0,r.jsx)(n.h4,{id:"\u4e00\u4e2aio\u8bf7\u6c42\u8fdb\u5165block-layer\u4e4b\u540e\u53ef\u80fd\u4f1a\u7ecf\u5386\u4e0b\u9762\u7684\u8fc7\u7a0b",children:"\u4e00\u4e2aI/O\u8bf7\u6c42\u8fdb\u5165block layer\u4e4b\u540e\uff0c\u53ef\u80fd\u4f1a\u7ecf\u5386\u4e0b\u9762\u7684\u8fc7\u7a0b\uff1a"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"I/O enters block layer \u2013 it can be:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Remapped onto another device (MD, DM)"}),"\n",(0,r.jsx)(n.li,{children:"Split into 2 separate I/Os (alignment, size, ...)"}),"\n",(0,r.jsx)(n.li,{children:"Added to the request queue"}),"\n",(0,r.jsx)(n.li,{children:"Merged with a previous entry on the queue All I/Os end up on a request queue at some point"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"At some later time, the I/O is issued to a device driver, and submitted to a device"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Later, the I/O is completed by the device, and its driver"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"blkparse\u663e\u793a\u7684\u5404\u6307\u6807\u70b9\u793a\u610f",children:"blkparse\u663e\u793a\u7684\u5404\u6307\u6807\u70b9\u793a\u610f\uff1a"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:" Q-------&gt;G------------&gt;I---------&gt;M-------------------&gt;D-----------------------------&gt;C\n |-Q time-|-Insert time-|\n |--------- merge time ------------|-merge with other IO|\n |----------------scheduler time time-------------------|---driver,adapter,storagetime--|\n \n |----------------------- await time in iostat output ----------------------------------|\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u5176\u4e2d\uff1a"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Q2Q \u2014 time between requests sent to the block layer"}),"\n",(0,r.jsx)(n.li,{children:"Q2G \u2014 time from a block I/O is queued to the time it gets a request allocated for it"}),"\n",(0,r.jsx)(n.li,{children:"G2I \u2014 time from a request is allocated to the time it is Inserted into the device's queue"}),"\n",(0,r.jsx)(n.li,{children:"Q2M \u2014 time from a block I/O is queued to the time it gets merged with an existing request"}),"\n",(0,r.jsx)(n.li,{children:"I2D \u2014 time from a request is inserted into the device's queue to the time it is actually issued to the device"}),"\n",(0,r.jsx)(n.li,{children:"M2D \u2014 time from a block I/O is merged with an exiting request until the request is issued to the device"}),"\n",(0,r.jsx)(n.li,{children:"D2C \u2014 service time of the request by the device"}),"\n",(0,r.jsx)(n.li,{children:"Q2C \u2014 total time spent in the block layer for a request"}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"blktrace-\u80fd\u591f\u8bb0\u5f55\u4e0bio\u6240\u7ecf\u5386\u7684\u5404\u4e2a\u6b65\u9aa4",children:"blktrace \u80fd\u591f\u8bb0\u5f55\u4e0bIO\u6240\u7ecf\u5386\u7684\u5404\u4e2a\u6b65\u9aa4:"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"http://images2017.cnblogs.com/blog/970272/201711/970272-20171123172811758-499318951.png?x-oss-process=image/resize,w_1400/format,webp",alt:""})}),"\n",(0,r.jsx)(n.p,{children:"blktrace\u7684\u8f93\u51fa:"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"http://images2017.cnblogs.com/blog/970272/201711/970272-20171123172850274-409654510.png?x-oss-process=image/resize,w_1400/format,webp",alt:""})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u7b2c\u4e00\u4e2a\u5b57\u6bb5\uff1a8,0 \u8fd9\u4e2a\u5b57\u6bb5\u662f\u8bbe\u5907\u53f7 major device ID\u548cminor device ID\u3002"}),"\n",(0,r.jsx)(n.li,{children:"\u7b2c\u4e8c\u4e2a\u5b57\u6bb5\uff1a3 \u8868\u793aCPU"}),"\n",(0,r.jsx)(n.li,{children:"\u7b2c\u4e09\u4e2a\u5b57\u6bb5\uff1a11 \u5e8f\u5217\u53f7"}),"\n",(0,r.jsx)(n.li,{children:"\u7b2c\u56db\u4e2a\u5b57\u6bb5\uff1a0.009507758 Time Stamp\u662f\u65f6\u95f4\u504f\u79fb"}),"\n",(0,r.jsx)(n.li,{children:"\u7b2c\u4e94\u4e2a\u5b57\u6bb5\uff1aPID \u672c\u6b21IO\u5bf9\u5e94\u7684\u8fdb\u7a0bID"}),"\n",(0,r.jsx)(n.li,{children:"\u7b2c\u516d\u4e2a\u5b57\u6bb5\uff1aEvent\uff0c\u8fd9\u4e2a\u5b57\u6bb5\u975e\u5e38\u91cd\u8981\uff0c\u53cd\u6620\u4e86IO\u8fdb\u884c\u5230\u4e86\u90a3\u4e00\u6b65"}),"\n",(0,r.jsx)(n.li,{children:"\u7b2c\u4e03\u4e2a\u5b57\u6bb5\uff1aR\u8868\u793a Read\uff0c W\u662fWrite\uff0cD\u8868\u793ablock\uff0cB\u8868\u793aBarrier Operation"}),"\n",(0,r.jsx)(n.li,{children:"\u7b2c\u516b\u4e2a\u5b57\u6bb5\uff1a223490+56\uff0c\u8868\u793a\u7684\u662f\u8d77\u59cbblock number \u548c number of blocks\uff0c\u5373\u6211\u4eec\u5e38\u8bf4\u7684Offset \u548c Size"}),"\n",(0,r.jsx)(n.li,{children:"\u7b2c\u4e5d\u4e2a\u5b57\u6bb5\uff1a \u8fdb\u7a0b\u540d"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"\u5176\u4e2d\u7b2c\u516d\u4e2a\u5b57\u6bb5\u975e\u5e38\u6709\u7528\uff1a\u6bcf\u4e00\u4e2a\u5b57\u6bcd\u90fd\u4ee3\u8868\u4e86IO\u8bf7\u6c42\u6240\u7ecf\u5386\u7684\u67d0\u4e2a\u9636\u6bb5\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"Q \u2013 \u5373\u5c06\u751f\u6210IO\u8bf7\u6c42\n|\nG \u2013 IO\u8bf7\u6c42\u751f\u6210\n|\nI \u2013 IO\u8bf7\u6c42\u8fdb\u5165IO Scheduler\u961f\u5217\n|\nD \u2013 IO\u8bf7\u6c42\u8fdb\u5165driver\n|\nC \u2013 IO\u8bf7\u6c42\u6267\u884c\u5b8c\u6bd5\n"})}),"\n",(0,r.jsx)(n.h2,{id:"blktrace\u7684\u7528\u6cd5",children:"blktrace\u7684\u7528\u6cd5"}),"\n",(0,r.jsx)(n.p,{children:"\u5b9e\u9645\u4e0ablktrace\u4ec5\u4ec5\u662f\u7528\u6765\u91c7\u96c6\u6570\u636e\uff0c\u6570\u636e\u7684\u5206\u6790\u5176\u5b9e\u6709\u5f88\u591a\u8f85\u52a9\u7684\u5de5\u5177\uff0c\u6bd4\u5982\uff1a"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"blkparse"}),"\n",(0,r.jsx)(n.li,{children:"btt"}),"\n",(0,r.jsx)(n.li,{children:"blkiomon"}),"\n",(0,r.jsx)(n.li,{children:"iowatcher"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"\u8fd9\u4e9b\u5de5\u5177\u90fd\u662f\u5229\u7528blktrace\u91c7\u96c6\u7684\u6570\u636e\uff0c\u66f4\u597d\u7684\u5206\u6790\uff0c\u7136\u540e\u8f93\u51fa\u3002"}),"\n",(0,r.jsx)(n.p,{children:"\u4f7f\u7528blktrace\u524d\u63d0\u9700\u8981\u6302\u8f7ddebugfs\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"mount      \u2013t debugfs    debugfs /sys/kernel/debug\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u5b9e\u65f6\u67e5\u770b",children:"\u5b9e\u65f6\u67e5\u770b\uff1a"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"blktrace\u53ea\u8d1f\u8d23\u91c7\u96c6\uff0cblkparse \u8d1f\u8d23\u89e3\u6790\u6210\u9002\u5408\u4eba\u7c7b\u770b\u7684\u6587\u5b57\uff1a\nblktrace -o \u6307\u5b9a\u8f93\u51fa\n#blktrace -d /dev/sda -o - | blkparse -i -\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u5148\u91c7\u96c6\u518d\u67e5\u770b",children:"\u5148\u91c7\u96c6\uff0c\u518d\u67e5\u770b\uff1a"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"1. \u5148\u91c7\u96c6\uff0c\u5c06\u4f1a\u5728\u5f53\u524d\u76ee\u5f55\u83b7\u5f97\u4e00\u5806\u7684\u6587\u4ef6,\u7f3a\u7701\u7684\u8f93\u51fa\u6587\u4ef6\u540d\u662f sdb.blktrace.&lt;cpu&gt;\uff0c\u6bcf\u4e2aCPU\u5bf9\u5e94\u4e00\u4e2a\u6587\u4ef6\u3002\n#blktrace /dev/sda /dev/sdb\n2. \u7ed9blkparse\u4f20\u9012\u78c1\u76d8\u7684\u540d\u5b57\uff0c\u5c06\u4f1a\u76f4\u63a5\u89e3\u6790\u3002\n#blkparse sda sdb\n"})}),"\n",(0,r.jsx)(n.h3,{id:"blktrace\u4ea7\u751f\u7684\u6587\u4ef6\u592a\u96f6\u6563\u600e\u4e48\u529e",children:"blktrace\u4ea7\u751f\u7684\u6587\u4ef6\u592a\u96f6\u6563\u600e\u4e48\u529e\uff1f"}),"\n",(0,r.jsx)(n.h4,{id:"\u751f\u6210\u91c7\u96c6\u6587\u4ef6",children:"\u751f\u6210\u91c7\u96c6\u6587\u4ef6"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"#blktrace -d /dev/sda\n"})}),"\n",(0,r.jsx)(n.h4,{id:"\u5408\u5e76\u6210\u4e00\u4e2a\u4e8c\u8fdb\u5236\u6587\u4ef6",children:"\u5408\u5e76\u6210\u4e00\u4e2a\u4e8c\u8fdb\u5236\u6587\u4ef6"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"#blkparse -i sda -d sda.blktrace.bin\n"})}),"\n",(0,r.jsx)(n.h4,{id:"\u5176\u5b9e\u6211\u4eec\u8fd8\u662f\u5acc\u5f03blkparse\u7684\u8f93\u51fa\u592a\u591a\u4e0d\u65b9\u4fbf\u67e5\u770b\u6b64\u65f6\u53ef\u4ee5\u5229\u7528btt\u534f\u52a9\u5206\u6790\u7edf\u8ba1",children:"\u5176\u5b9e\u6211\u4eec\u8fd8\u662f\u5acc\u5f03blkparse\u7684\u8f93\u51fa\u592a\u591a\uff0c\u4e0d\u65b9\u4fbf\u67e5\u770b\uff0c\u6b64\u65f6\u53ef\u4ee5\u5229\u7528btt\u534f\u52a9\u5206\u6790\u7edf\u8ba1"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"#btt -i sda.blktrace.bin -l sda.d2c_latency\n\n# \u8fd9\u91cc\u5c31\u53ef\u4ee5\u770b\u5230\uff0c\u6bcf\u4e2a\u9636\u6bb5\uff0c\u6d88\u8017\u7684\u65f6\u95f4\n[root@localhost2 /data/sandbox/blktrace_test]\n#btt -i sda.blktrace.bin -l sda.d2c_latency\n==================== All Devices ====================\n\n            ALL           MIN           AVG           MAX           N\n--------------- ------------- ------------- ------------- -----------\n\nQ2Q               0.000000238   0.126069031   5.007614945          40\nQ2G               0.000000556   0.000001765   0.000006022          11\nG2I               0.000000528   0.000003506   0.000015113          11\nQ2M               0.000000135   0.000000209   0.000001162          30\nI2D               0.000000396   0.000001240   0.000003602          11\nM2D               0.000002235   0.000007047   0.000014071          30\nD2C               0.003104665   0.015828304   0.028136240          41\nQ2C               0.003117684   0.015835360   0.028138401          41\n\n# \u8fd9\u91cc\u770b\u5230\u6574\u4e2aIO\u4e0b\u6765\uff0c\u6bcf\u4e2a\u9636\u6bb5\u6240\u6d88\u8017\u7684\u65f6\u95f4\uff0c\u5360\u7528\u767e\u5206\u6bd4\n==================== Device Overhead ====================\n\n       DEV |       Q2G       G2I       Q2M       I2D       D2C\n---------- | --------- --------- --------- --------- ---------\n (  8,  0) |   0.0030%   0.0059%   0.0010%   0.0021%  99.9554%\n---------- | --------- --------- --------- --------- ---------\n   Overall |   0.0030%   0.0059%   0.0010%   0.0021%  99.9554%\n\n==================== Device Merge Information ====================\n\n       DEV |       #Q       #D   Ratio |   BLKmin   BLKavg   BLKmax    Total\n---------- | -------- -------- ------- | -------- -------- -------- --------\n (  8,  0) |       41       11     3.7 |        8       29      144      328\n \n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Q2I \u2013 time it takes to process an I/O prior to it being inserted or merged onto a request queue \u2013 Includes split, and remap time"}),"\n",(0,r.jsx)(n.li,{children:"I2D \u2013 time the I/O is \u201cidle\u201d on the request queue"}),"\n",(0,r.jsx)(n.li,{children:"D2C \u2013 time the I/O is \u201cactive\u201d in the driver and on the device"}),"\n",(0,r.jsx)(n.li,{children:"Q2I + I2D + D2C = Q2C"}),"\n",(0,r.jsx)(n.li,{children:"Q2C: Total processing time of the I/O"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"\u6ce8\u610f\uff1a"}),"\n",(0,r.jsx)(n.p,{children:"D2C: \u8868\u5f81\u5757\u8bbe\u5907\u6027\u80fd\u7684\u5173\u952e\u6307\u6807"}),"\n",(0,r.jsx)(n.p,{children:"Q2C: \u5ba2\u6237\u53d1\u8d77\u8bf7\u6c42\u5230\u6536\u5230\u54cd\u5e94\u7684\u65f6\u95f4"}),"\n",(0,r.jsx)(n.p,{children:"D2C \u5e73\u5747\u65f6\u95f4\uff1a0.015828304 \u79d2\uff0c\u537315.82\u6beb\u79d2"}),"\n",(0,r.jsx)(n.p,{children:"Q2C \u5e73\u5747\u65f6\u95f4\uff1a0.015835360 \u79d2\uff0c\u537315.83\u6beb\u79d2"}),"\n",(0,r.jsx)(n.p,{children:"\u5e73\u5747\u4e0b\u6765\uff0cD2C \u9636\u6bb5\u6d88\u8017\u65f6\u95f4\u5360\u6bd4 99.9554%"}),"\n",(0,r.jsx)(n.h4,{id:"\u4e0a\u8ff0\u547d\u4ee4\u5176\u5b9e\u8fd8\u4f1a\u4ea7\u751f\u4e00\u4e9bdat\u6587\u4ef6\u53ef\u4ee5\u770b\u5230iops\u4fe1\u606f",children:"\u4e0a\u8ff0\u547d\u4ee4\u5176\u5b9e\u8fd8\u4f1a\u4ea7\u751f\u4e00\u4e9b.dat\u6587\u4ef6\uff0c\u53ef\u4ee5\u770b\u5230iops\u4fe1\u606f"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"#ll *.dat\n-rw-r--r-- 1 root root    6 Nov 21 14:51 8,0_iops_fp.dat\n-rw-r--r-- 1 root root   11 Nov 21 14:51 8,0_mbps_fp.dat\n-rw-r--r-- 1 root root 3006 Nov 21 14:51 sda.d2c_latency_8,0_d2c.dat\n-rw-r--r-- 1 root root    6 Nov 21 14:51 sys_iops_fp.dat\n-rw-r--r-- 1 root root   11 Nov 21 14:51 sys_mbps_fp.dat\n5. btt -q \n#btt -i sda.blktrace.bin -q sda.q2c_latency\n"})}),"\n",(0,r.jsx)(n.h4,{id:"\u6587\u4ef6\u89e3\u91ca",children:"\u6587\u4ef6\u89e3\u91ca\uff1a"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"sys_mbps_fs.dat"}),": \u672c\u6b21\u7edf\u8ba1\u4e2d\u6240\u6709\u8bbe\u5907\u541e\u5410\u91cf"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"sys_iops_fp.dat"}),": \u4e2d\u662f\u672c\u6b21\u7edf\u8ba1\u4e2d\u6240\u6709\u8bbe\u5907\u7684IOPS"]}),"\n",(0,r.jsx)(n.p,{children:"\u6bcf\u4e2a\u8bf7\u6c42\u7684d2c\u7684latency\u8be6\u60c5:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"sda.d2c_latency_8,0_d2c.dat\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u4fee\u6539blkparse\u7684\u8f93\u51fa\u683c\u5f0f",children:"\u4fee\u6539blkparse\u7684\u8f93\u51fa\u683c\u5f0f\uff1a"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'[root@localhost2 /data/sandbox]\n#blktrace -d /dev/sda -o - | blkparse -i - -f "%D %2c %8s %5T.%9t %5p %2a %3d\\n"\n  8,0    9        1     0.000000000  8863  A   W\n'})}),"\n",(0,r.jsx)(n.h3,{id:"\u4e00\u6b21io\u7684\u751f\u547d\u5468\u671fdirect-read-\u9644\u5f55\u89c1\u6d4b\u8bd5\u4ee3\u7801",children:"\u4e00\u6b21IO\u7684\u751f\u547d\u5468\u671f\uff1adirect read \u9644\u5f55\u89c1\u6d4b\u8bd5\u4ee3\u7801"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"[root@localhost /home/ahao.mah/sdc]\n#blktrace -d /dev/sdc  -o - | blkparse -i -\n\n  8,32   7        1     0.000000000  2923  Q   R 272208 + 2 [direct_io_read_]\n  8,32   7        2     0.000002526  2923  G   R 272208 + 2 [direct_io_read_]\n  8,32   7        3     0.000003142  2923  P   N [direct_io_read_]\n  8,32   7        4     0.000004575  2923  I   R 272208 + 2 [direct_io_read_]\n  8,32   7        5     0.000005402  2923  U   N [direct_io_read_] 1\n  8,32   7        6     0.000006775  2923  D   R 272208 + 2 [direct_io_read_]\n  8,32   7        7     0.000200150 32031  C   R 272208 + 2 [0]\n  \n\u4ee5\u4e0a\u5c31\u662f\u4e00\u6b21IO\u8bf7\u6c42\u7684\u751f\u547d\u5468\u671f\uff0c\u4eceactions\u770b\u5230\uff0c\u5206\u522b\u662fQGPIUDC\nQ\uff1a\u5148\u4ea7\u751f\u4e00\u4e2a\u8be5\u4f4d\u7f6e\u7684IO\u610f\u5411\u63d2\u5165\u5230io\u961f\u5217\uff0c\u6b64\u65f6\u5e76\u6ca1\u6709\u771f\u6b63\u7684\u8bf7\u6c42\nG\uff1a\u53d1\u9001\u4e00\u4e2a\u5b9e\u9645\u7684Io\u8bf7\u6c42\u7ed9\u8bbe\u5907\nP\uff08plugging\uff09\uff1a\u63d2\u5165\uff1a\u5373\u7b49\u5f85\u5373\u5c06\u5230\u6765\u7684\u66f4\u591a\u7684io\u8bf7\u6c42\u8fdb\u5165\u961f\u5217\uff0c\u4ee5\u4fbf\u7cfb\u7edf\u80fd\u8fdb\u884cIO\u4f18\u5316\uff0c\u51cf\u5c11\u6267\u884cIO\u8bf7\u6c42\u65f6\u82b1\u7684\u65f6\u95f4\nI\uff1a\u5c06IO\u8bf7\u6c42\u8fdb\u884c\u8c03\u5ea6\uff0c\u5230\u8fd9\u4e00\u6b65\u8bf7\u6c42\u5df2\u7ecf\u5b8c\u5168\u6210\u578b\uff08formed\uff09\u597d\u4e86\nU (unplugging)\uff1a\u62d4\u51fa\uff0c\u8bbe\u5907\u51b3\u5b9a\u4e0d\u518d\u7b49\u5f85\u5176\u4ed6\u7684IO\u8bf7\u6c42\u5e76\u4f7f\u5f97\u7cfb\u7edf\u5fc5\u987b\u54cd\u5e94\u5f53\u524dIO\u8bf7\u6c42\uff0c\u5c06\u8be5IO\u8bf7\u6c42\u4f20\u7ed9\u8bbe\u5907\u9a71\u52a8\u5668\u3002\u53ef\u4ee5\u770b\u5230\uff0c\u5728P\u548cU\u4e4b\u95f4\u4f1a\u7b49\u5f85IO\uff0c\u7136\u540e\u8fdb\u884c\u8c03\u5ea6\u3002\u8fd9\u91cc\u4f1a\u5bf9IO\u8fdb\u884c\u4e00\u70b9\u4f18\u5316\uff0c\n \u4f46\u662f\u7a0b\u5ea6\u5f88\u4f4e\uff0c\u56e0\u4e3a\u7b49\u5f85\u7684\u65f6\u95f4\u5f88\u77ed\uff0c\u662f\u7eb3\u79d2\u7ea7\u522b\u7684\nD \uff1a\u53d1\u5e03\u521a\u624d\u9001\u5165\u9a71\u52a8\u5668\u7684IO\u8bf7\u6c42\nC\uff1a\u7ed3\u675fIO\u8bf7\u6c42\uff0c\u8fd9\u91cc\u4f1a\u8fd4\u56de\u4e00\u4e2a\u6267\u884c\u72b6\u6001\uff1a\u5931\u8d25\u6216\u8005\u6210\u529f\uff0c\u5728\u8fdb\u7a0b\u53f7\u5904\u4e3a0\u8868\u793a\u6267\u884c\u6210\u529f\uff0c\u53cd\u4e4b\u5219\u53cd\n\u5230\u6b64\u4e00\u4e2aIO\u7684\u5468\u671f\u5c31\u7ed3\u675f\u4e86\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u4e00\u6b21io\u7684\u751f\u547d\u5468\u671fdirect-write-\u9644\u5f55\u89c1\u6d4b\u8bd5\u4ee3\u7801",children:"\u4e00\u6b21IO\u7684\u751f\u547d\u5468\u671f\uff1adirect write \u9644\u5f55\u89c1\u6d4b\u8bd5\u4ee3\u7801"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"[root@localhost /home/ahao.mah/sdc]\n#taskset -c 1 ./direct_io_write_file_one &amp;\n[1] 57376\nwrite success\n[1]+  Done                    taskset -c 1 ./direct_io_write_file_one\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"[root@localhost /home/ahao.mah/blktrace/jiangyi]\n#time /usr/bin/blktrace  -w 100 -d /dev/sdc -o -  | /usr/bin/blkparse -w 100   -i -\n\n  8,32   1        1     0.000000000 57376  Q  WS 272208 + 2 [direct_io_write]\n  8,32   1        2     0.000005514 57376  G  WS 272208 + 2 [direct_io_write]\n  8,32   1        3     0.000006880 57376  P   N [direct_io_write]\n  8,32   1        4     0.000009793 57376  I  WS 272208 + 2 [direct_io_write]\n  8,32   1        5     0.000011264 57376  U   N [direct_io_write] 1\n  8,32   1        6     0.000013478 57376  D  WS 272208 + 2 [direct_io_write]\n  8,32   0        1     0.000281069     0  C  WS 272208 + 2 [0]\n"})}),"\n",(0,r.jsx)(n.h3,{id:"blktrace--a-\u53c2\u6570\u53ef\u4ee5\u6307\u5b9a\u76d1\u63a7\u7684\u52a8\u4f5c",children:"blktrace -a \u53c2\u6570\u53ef\u4ee5\u6307\u5b9a\u76d1\u63a7\u7684\u52a8\u4f5c\uff1a"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"1.     blktrace /dev/block/mmcblk0p1 -o /data/trace  \u547d\u4ee4\u89e3\u6790\uff1a\u76d1\u63a7mmcblk0p1\u5757\u8bbe\u5907\uff0c\u5c06\u751f\u6210\u7684\u6587\u4ef6\u5b58\u50a8\u5728/data\u76ee\u5f55\u4e0b\uff0c\u4e00\u5171\u751f\u62104\u4e2a\u6587\u4ef6\uff0c\u6587\u4ef6\u4ee5trace\u5f00\u5934\uff0c\u5206\u522b\u4e3atrace.blktrace.0  trace.blktrace.1 trace.blktrace.2trace.blktrace.3\u5206\u522b\u5bf9\u5e94cpu0\u3001cpu1\u3001cpu2\u3001cpu3\n2.     blktrace /dev/block/mmcblk0p1 -D /data/trace  \u547d\u4ee4\u89e3\u6790\uff1a\u76d1\u63a7mmcblk0p1\u5757\u8bbe\u5907\uff0c\u5728/data\u76ee\u5f55\u4e0b\u5efa\u7acb\u4e00\u4e2a\u540d\u5b57\u4e3atrace\u7684\u6587\u4ef6\u5939\uff0ctrace\u6587\u4ef6\u5939\u4e0b\u5b58\u653e\u7684\u662f\u540d\u5b57\u4e3a                                                                   mmcblk0p1.blktrace.0mmcblk0p1.blktrace.1 mmcblk0p1.blktrace.2 mmcblk0p1.blktrace.3                                                                   \u5206\u522b\u5bf9\u5e94cpu0 cpu1 cpu2 cpu3\n3.     blktrace /dev/block/mmcblk0p1 -o /data/trace -w 10  \u547d\u4ee4\u89e3\u6790\uff1a-w \u9009\u9879\u8868\u793a\u591a\u957f\u65f6\u95f4\u4e4b\u540e\u505c\u6b62\u76d1\u63a7(\u5355\u4f4d\uff1a\u79d2\uff09  -w 10 \u8868\u793a10\u79d2\u4e4b\u540e\u505c\u6b62\u76d1\u63a7\n4.     blktrace /dev/block/mmcblk0p1 -o /data/trace -a WRITE   \u547d\u4ee4\u89e3\u6790\uff1a-a \u4ee3\u8868\u53ea\u76d1\u63a7\u5199\u64cd\u4f5c\n\u9009\u9879 -a action \u8868\u793a\u8981\u76d1\u63a7\u7684\u52a8\u4f5c\uff0caction\u7684\u52a8\u4f5c\u6709\uff1a\nREAD \uff08\u8bfb\uff09\nWRITE\uff08\u5199\uff09\nBARRIER\nSYNC\nQUEUE\nREQUEUE\nISSUE\nCOMPLETE\nFS\nPC\n"})}),"\n",(0,r.jsxs)(n.h2,{id:"\u5176\u4ed6\u5de5\u5177",children:["\u5176\u4ed6\u5de5\u5177",":blkiomon"]}),"\n",(0,r.jsx)(n.p,{children:"\u5bf9\u8bbe\u5907/dev/sda\u7684io\u76d1\u63a7120\u79d2\uff0c\u6bcf2\u79d2\u663e\u793a\u4e00\u6b21"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"# blktrace /dev/sda -a issue -a complete -w 120 -o - | blkiomon  -I 2 -h -\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"[root@localhost2 /data/sandbox/blktrace_test]\n# blktrace /dev/sda -a issue -a complete -w 120 -o - | blkiomon  -I 2 -h -\n\ntime: Tue Nov 21 14:04:48 2017\ndevice: 8,0\nsizes read (bytes): num 0, min -1, max 0, sum 0, squ 0, avg 0.0, var 0.0\nsizes write (bytes): num 2, min 4096, max 49152, sum 53248, squ 2432696320, avg 26624.0, var 507510784.0\nd2c read (usec): num 0, min -1, max 0, sum 0, squ 0, avg 0.0, var 0.0\nd2c write (usec): num 2, min 8322, max 10708, sum 19030, squ 183916948, avg 9515.0, var 1423249.0\nthroughput read (bytes/msec): num 0, min -1, max 0, sum 0, squ 0, avg 0.0, var 0.0\nthroughput write (bytes/msec): num 2, min 492, max 4590, sum 5082, squ 21310164, avg 2541.0, var 4198401.0\nsizes histogram (bytes):\n            0:     0         1024:     0         2048:     0         4096:     1\n         8192:     0        16384:     0        32768:     0        65536:     1\n       131072:     0       262144:     0       524288:     0      1048576:     0\n      2097152:     0      4194304:     0      8388608:     0    &gt; 8388608:     0\nd2c histogram (usec):\n            0:     0            8:     0           16:     0           32:     0\n           64:     0          128:     0          256:     0          512:     0\n         1024:     0         2048:     0         4096:     0         8192:     0\n        16384:     2        32768:     0        65536:     0       131072:     0\n       262144:     0       524288:     0      1048576:     0      2097152:     0\n      4194304:     0      8388608:     0     16777216:     0     33554432:     0\n    &gt;33554432:     0\nbidirectional requests: 0\n"})}),"\n",(0,r.jsx)(n.h2,{id:"ref",children:"Ref"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.a,{href:"http://man7.org/linux/man-pages/man1/iowatcher.1.html",children:"iowatcher man"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.a,{href:"http://www.cse.unsw.edu.au/~aaronc/iosched/doc/blktrace.html",children:"http://www.cse.unsw.edu.au/~aaronc/iosched/doc/blktrace.html"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.a,{href:"http://duch.mimuw.edu.pl/~lichota/09-10/Optymalizacja-open-source/Materialy/10%20-%20Dysk/gelato_ICE06apr_blktrace_brunelle_hp.pdf",children:"blktrace PDF"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.a,{href:"http://bean-li.github.io/blktrace-to-report/",children:"blktrace\u5206\u6790IO"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.a,{href:"http://blog.csdn.net/u012317833/article/details/23275005",children:"http://blog.csdn.net/u012317833/article/details/23275005"})}),"\n",(0,r.jsx)(n.h3,{id:"blktrace-git",children:"blktrace git"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"git clone git://git.kernel.dk/blktrace.git\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u6d4b\u8bd5\u4ee3\u7801",children:"\u6d4b\u8bd5\u4ee3\u7801"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'#cat direct_io_read_file_one.c\n#include &lt;stdio.h&gt;\n#include &lt;stdlib.h&gt;\n#include &lt;unistd.h&gt;\n#include &lt;sys/file.h&gt;\n#include &lt;sys/types.h&gt;\n#include &lt;sys/stat.h&gt;\n#include &lt;string.h&gt;\n#define BUF_SIZE 1024\n\nint main()\n{\n    int fd;\n    int ret;\n    unsigned char *buf;\n    ret = posix_memalign((void **)&amp;buf, 512, BUF_SIZE);\n    if (ret) {\n        perror("posix_memalign failed");\n        exit(1);\n    }\n\n    fd = open("./direct_io.data", O_RDONLY | O_DIRECT, 0755);\n    if (fd &lt; 0){\n        perror("open ./direct_io.data failed");\n        exit(1);\n    }\n\n    ret = read(fd, buf, BUF_SIZE);\n    if (ret &lt; 0) {\n        perror("write ./direct_io.data failed");\n    }\n\n    free(buf);\n    close(fd);\n}\n'})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'[root@localhost /home/ahao.mah/sdc]\n#cat  direct_io_write_file_one.c\n#define _GNU_SOURCE\n#include &lt;stdio.h&gt;\n#include &lt;stdlib.h&gt;\n#include &lt;unistd.h&gt;\n#include &lt;sys/file.h&gt;\n#include &lt;sys/types.h&gt;\n#include &lt;sys/stat.h&gt;\n#include &lt;string.h&gt;\n#define BUF_SIZE 1024\n\nint main(int argc, char * argv[])\n{\n    int fd;\n    int ret;\n    unsigned char *buf;\n    ret = posix_memalign((void **)&amp;buf, 512, BUF_SIZE);\n    if (ret) {\n        perror("posix_memalign failed");\n        exit(1);\n    }\n    memset(buf, \'c\', BUF_SIZE);\n\n    fd = open("./direct_io.data", O_WRONLY | O_CREAT | O_DIRECT, 0755);\n    if (fd &lt; 0){\n        perror("open ./direct_io.data failed");\n        free(buf);\n        exit(1);\n    }\n\n    ret = write(fd, buf, BUF_SIZE);\n    if (ret &lt; 0) {\n        perror("write ./direct_io.data failed");\n    } else {\n        printf("write success\\n");\n    }\n\n    free(buf);\n    close(fd);\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.a,{href:"https://developer.aliyun.com/article/698568",children:"IO\u795e\u5668blktrace\u4f7f\u7528\u4ecb\u7ecd-\u963f\u91cc\u4e91\u5f00\u53d1\u8005\u793e\u533a"})})]})}function h(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(o,{...e})}):o(e)}},28453:(e,n,i)=>{i.d(n,{R:()=>s,x:()=>c});var t=i(96540);const r={},l=t.createContext(r);function s(e){const n=t.useContext(l);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),t.createElement(l.Provider,{value:n},e.children)}}}]);